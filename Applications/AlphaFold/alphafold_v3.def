bootstrap: docker
from: docker.io/nvidia/cuda:12.6.3-base-ubuntu24.04

%post
    export DEBIAN_FRONTEND=noninteractive

    # Get latest package listing, install software-properties-common, git, wget,
    # compilers and libraries.
    # git is required for pyproject.toml toolchain's use of CMakeLists.txt.
    # gcc, g++, make are required for compiling hmmer and AlphaFold 3 libaries.
    # zlib is a required dependency of AlphaFold 3.
    apt-get update --quiet \
        && apt-get install --yes --quiet software-properties-common \
        && apt-get install --yes --quiet git wget gcc g++ make zlib1g-dev zstd

    apt-get install --yes --quiet python3.12 python3-pip python3.12-venv python3.12-dev

    # Update pip to the latest version. Not necessary in Docker, but good to do when
    # this is used as a recipe for local installation since we rely on new pip
    # features for secure installs.
    python3 -m venv /alphafold3_venv
    PATH="/hmmer/bin:/alphafold3_venv/bin:$PATH"
    pip3 install --no-cache-dir --upgrade pip

    # Install HMMER. Do so before copying the source code, so that docker can cache
    # the image layer containing HMMER. Alternatively, you could also install it
    # using `apt-get install hmmer` instead of bulding it from source, but we want
    # to have control over the exact version of HMMER and also apply the sequence
    # limit patch. Also note that eddylab.org unfortunately doesn't support HTTPS
    # and the tar file published on GitHub is explicitly not recommended to be used
    # for building from source.
    mkdir /hmmer_build /hmmer ; \
        wget http://eddylab.org/software/hmmer/hmmer-3.4.tar.gz --directory-prefix /hmmer_build ; \
        (cd /hmmer_build && echo "ca70d94fd0cf271bd7063423aabb116d42de533117343a9b27a65c17ff06fbf3 hmmer-3.4.tar.gz" | sha256sum --check) && \
        (cd /hmmer_build && tar zxf hmmer-3.4.tar.gz && rm hmmer-3.4.tar.gz)

    # Copy the AlphaFold 3 source code from the local machine to the container app/ folder
    mkdir -p /app
    cd /app/
    git clone https://github.com/google-deepmind/alphafold3.git alphafold

    # Apply the --seq_limit patch to HMMER.
    cp /app/alphafold/docker/jackhmmer_seq_limit.patch /hmmer_build/
    (cd /hmmer_build && patch -p0 < jackhmmer_seq_limit.patch)

    # Build HMMER.
    (cd /hmmer_build/hmmer-3.4 && ./configure --prefix /hmmer) ; \
        (cd /hmmer_build/hmmer-3.4 && make -j) ; \
        (cd /hmmer_build/hmmer-3.4 && make install) ; \
        (cd /hmmer_build/hmmer-3.4/easel && make install) ; \
        rm -R /hmmer_build

    # Install the Python dependencies AlphaFold 3 needs.
    cd /app/alphafold
    pip3 install --no-cache-dir setuptools
    pip3 install --no-cache-dir -r dev-requirements.txt
    pip3 install --no-cache-dir --no-deps .

    # Build chemical components database (this binary was installed by pip).
    build_data

    # create directories for models and database
    mkdir -p /data
    mkdir -p /models

%environment
    # set python env
    export PATH="/hmmer/bin:/alphafold3_venv/bin:${PATH}"

    # to avoid potentially-conflicting Python packages installed in ~/.local
    export PYTHONNOUSERSITE=true

    # To work around a known XLA issue causing the compilation time to greatly
    # increase, the following environment variable setting XLA flags must be enabled
    # when running AlphaFold 3:
    export XLA_FLAGS="--xla_gpu_enable_triton_gemm=false"

    # Memory settings used for folding up to 5,120 tokens on A100 80 GB.
    export XLA_PYTHON_CLIENT_PREALLOCATE=true
    export XLA_CLIENT_MEM_FRACTION=0.95

%runscript
    exec python3 /app/alphafold/run_alphafold.py "$@"

%labels
    Authors paula_sanematsu@g.harvard.edu, nweeks@g.harvard.edu
    Version 3.0.1
    Definition file based on official Alphafold3 Dockerfile https://github.com/google-deepmind/alphafold3/blob/f3e86f27dfac16559d16f470bb2f9323eb357f1f/docker/Dockerfile

%help
    Singularity container to run Alphafold3 version 3.0.1, converted from the official Alphafold3 Dockerfile.
